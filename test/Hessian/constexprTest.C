// RUN: %cladclang %s -I%S/../../include -std=c++14 -oconstexprTest.out 2>&1 | %filecheck %s
// RUN: ./constexprTest.out | %filecheck_exec %s
// RUN: %cladclang -Xclang -plugin-arg-clad -Xclang -enable-tbr %s -I%S/../../include -std=c++14 -oconstexprTest.out
// RUN: ./constexprTest.out | %filecheck_exec %s
// CHECK-NOT: {{.*error|warning|note:.*}}

#include "clad/Differentiator/Differentiator.h"
#include <iostream>
#include "../TestUtils.h"

double mat_ref[4];
clad::array_ref<double> mat_ref_f(mat_ref, 4);

double j[2] = {3, 4};
double mat_ref1[9];
clad::array_ref<double>mat_ref_f1(mat_ref1, 9);

constexpr double fn(double x, double y) { return x * y; }

//CHECK: constexpr void fn_hessian(double x, double y, double *hessianMatrix) {
//CHECK-NEXT:    fn_darg0_pullback(x, y, 1, hessianMatrix + {{0U|0UL}}, hessianMatrix + {{1U|1UL}});
//CHECK-NEXT:    fn_darg1_pullback(x, y, 1, hessianMatrix + {{2U|2UL}}, hessianMatrix + {{3U|3UL}});
//CHECK-NEXT:}

constexpr double g(double i, double j[2]) { return i * (j[0] + j[1]); }

//CHECK: constexpr void g_hessian(double i, double j[2], double *hessianMatrix) {
//CHECK-NEXT:    g_darg0_pullback(i, j, 1, hessianMatrix + {{0U|0UL}}, hessianMatrix + {{1U|1UL}});
//CHECK-NEXT:    g_darg1_0_pullback(i, j, 1, hessianMatrix + {{3U|3UL}}, hessianMatrix + {{4U|4UL}});
//CHECK-NEXT:    g_darg1_1_pullback(i, j, 1, hessianMatrix + {{6U|6UL}}, hessianMatrix + {{7U|7UL}});
//CHECK-NEXT:}

int main() {
    
    INIT_HESSIAN(fn);
    INIT_HESSIAN(g, "i, j[0:1]");

    TEST_HESSIAN(fn, 2, 2, 3, mat_ref_f); // CHECK-EXEC: {0.00, 1.00, 1.00, 0.00}
    TEST_HESSIAN(g, 2, 2, j, mat_ref_f1); // CHECK-EXEC: {0.00, 1.00, 1.00, 1.00, 0.00, 0.00, 1.00, 0.00, 0.00}
}
